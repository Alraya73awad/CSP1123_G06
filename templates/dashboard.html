{% extends "base.html" %}

{% block page_title %}Dashboard | Clash of Code{% endblock %}

<style>
.algorithm-card {
    border: 2px solid #ccc;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.2s;
}

.algorithm-card:hover {
    border-color: #0d6efd;
    background-color: #f0f8ff;
}

.algorithm-radio:checked + .algorithm-card {
    border-color: #0d6efd;
    background-color: #e7f1ff;
    box-shadow: 0 0 8px rgba(13, 110, 253, 0.4);
}

</style>

{% block content %}

<h1>USER DASHBOARD // MAIN INTERFACE</h1>

<!-- flash .essages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-area">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<!-- header -->
<div class="dashboard-header cyber-header">
    <h2>Welcome, <span class="highlight">{{ current_user.username }}</span></h2>
    <p>Access your bots, stats, and battle systems below.</p>
</div>

<br>


<!-- player stats -->
<div class="stats-grid cyber-grid">

    <!-- lvls -->
    <div class="stat-card neon-panel">
        <h3>LEVEL</h3>
        <p>{{ current_user.level }}</p>
    </div>

<div class="stat-card neon-panel">
    <h3>XP</h3>
    <div class="xp-bar" style="width: 100%; background: rgba(0,0,0,0.2); height: 25px; border-radius: 6px; margin-top: 5px;">
        <div style="height: 100%; width: {{ xp_percent }}%; background: #00ffaa; border-radius: 6px;"></div>
    </div>
    <p>{{ user.xp }} / {{ xp_to_next }} XP</p>
</div>

<div class="stat-card neon-panel">
    <h3>STAT POINTS</h3>
    <p>{{ stat_points }}</p>
</div>


    <!-- tokens -->
    <div class="stat-card neon-panel">
        <h3>TOKENS</h3>
        <p>{{ current_user.tokens }}</p>
    </div>

</div>

<br><br>

<!-- bot list -->
<h2>Your Bots</h2>

{% if bots %}
    <div class="bot-list hologram-grid">
    {% for item in bots %}
        {% set bot = item.bot %}
        {% set final = item.final_stats %}

        <div class="bot-card holo-card">
            <div class="holo-glow"></div>
            <h3>{{ bot.name }} ({{ bot.algorithm }})</h3>
            <p>INT: {{ final.int }} | PROC: {{ final.proc }} | DEF: {{ final.def }} | CLK: {{ final.clk }} | LOGIC: {{ final.logic }} | ENT: {{ final.ent }} | PWR: {{ final.pwr }}</p>
        </div>
        {% endfor %}
    </div>
{% else %}
    <p>No bots found â€” create your first bot below.</p>
{% endif %}

<br><br>

<!-- bot form -->
<h2>Create a New Bot</h2>

<form method="POST">
<div class="mb-3">
    <label for="name">Bot Name:</label><br>
    <input type="text" id="name" name="name" required class="form-control"><br><br>
</div>

<div class="container">

    <label class="form-label fw-bold">Select Algorithm:</label>

    <div class="row row-cols-1 row-cols-md-3 g-3">

        {% for code, label in algorithms.items() %}
        <div class="col">

            <!-- Hidden radio input -->
            <input type="radio"
                   id="{{ code }}"
                   name="algorithm"
                   value="{{ code }}"
                   class="d-none algorithm-radio"
                   required>

            <!-- The card acts as the label -->
            <label for="{{ code }}" class="card algorithm-card text-center p-3" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ algorithm_descriptions[code] }}">
                <h5 class="fw-bold">{{ code }}</h5>
                <p class="text-muted">{{ label }}</p>
            </label>

        </div>
        {% endfor %}

    </div>

</div>



    <button type="submit" class="btn btn-outline-primary mt-4">Create Bot</button>

</form>

<br><br>

<!-- action buttons -->
<div class="action-grid">
    <a href="{{ url_for('battle_select') }}" class="action-button">BATTLE</a>
    <a href="{{ url_for('manage_bot') }}" class="action-button">MANAGE BOTS</a>
    <a href="{{ url_for('store') }}" class="action-button">STORE</a>
    <a href="{{ url_for('character') }}" class="action-button">CHARACTER</a>
    <a href="{{ url_for('history') }}" class="action-button">HISTORY</a>
</div>

<a href="{{ url_for('home') }}" class="icon-btn back-home-btn">
    <i class="fa-solid fa-house"></i>
</a>



<style>
.btn-terminal {
    padding: 12px 30px;
    border: 2px solid #00ffaa;
    border-radius: 10px;
    color: #00ffaa;
    background: rgba(0,0,10,0.7);
    font-family: 'VT323', monospace;
    font-size: 1.3rem;
    text-decoration: none;
    text-shadow: 0 0 5px #00ffaa;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
}

.btn-terminal:hover {
    background: rgba(0,255,170,0.1);
    box-shadow: 0 0 15px #00ffaa;
    transform: scale(1.05);
}
.btn-terminal i {
    margin-right: 10px;
}
</style>



<!-- level up -->
<div id="level-up-popup" class="level-up-popup hidden">
    <h1>LEVEL UP!</h1>
    <p>You reached Level <span id="new-level"></span>!</p>
</div>

<audio id="level-up-sound">
    <source src="{{ url_for('static', filename='sounds/level_up.mp3') }}" type="audio/mpeg">
</audio>

<div class="xp-ring-container">
    <svg class="xp-ring" width="150" height="150">
        <circle class="xp-bg" cx="75" cy="75" r="60" />
        <circle class="xp-progress" cx="75" cy="75" r="60" 
                style="--percent: {{ xp_percent }}%;" />
    </svg>
    <p>{{ current_user.xp }} / {{ current_user.level * 100 }} XP</p>
</div>

<!-- dashboard header -->
<div class="dashboard-header d-flex justify-content-between align-items-center">
     <button class="icon-btn settings-btn" data-bs-toggle="modal" data-bs-target="#settingsModal">
    <i class="fa-solid fa-gear"></i>
</button>


</div>

<!-- settings modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('update_settings') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Account Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" name="username" id="username" value="{{ current_user.username }}" class="form-control">
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" name="email" id="email" value="{{ current_user.email }}" class="form-control">
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">New Password</label>
                <input type="password" name="password" id="password" class="form-control">
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary neon-btn" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary neon-btn">Update Settings</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}