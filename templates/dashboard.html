{% extends "base.html" %}

{% block page_title %}Dashboard | Clash of Code{% endblock %}

<style>
.algorithm-card {
    border: 2px solid #ccc;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.2s;
}

.algorithm-card:hover {
    border-color: #0d6efd;
    background-color: #f0f8ff;
}

.algorithm-radio:checked + .algorithm-card {
    border-color: #0d6efd;
    background-color: #e7f1ff;
    box-shadow: 0 0 8px rgba(13, 110, 253, 0.4);
}

/* Bot card hover + clickable link */
.bot-link {
    text-decoration: none;
    color: inherit;
}
.bot-card {
    cursor: pointer;
    transition: transform 0.2s;
}
.bot-card:hover {
    transform: scale(1.02);
    box-shadow: 0 0 12px rgba(0,0,0,0.25);
}
</style>

{% block content %}

<h1>USER DASHBOARD // MAIN INTERFACE</h1>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-area">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<!-- WELCOME HEADER -->
<div class="dashboard-header cyber-header">
    <h2>Welcome, <span class="highlight">{{ current_user.username }}</span></h2>
    <p>Access your bots, stats, and battle systems below.</p>
</div>

<br>

<!-- PLAYER STATS (CYBER GRID) -->
<div class="stats-grid cyber-grid">

    <!-- LEVEL -->
    <div class="stat-card neon-panel">
        <h3>LEVEL</h3>
        <p>{{ current_user.level }}</p>
    </div>

    <!-- XP -->
    <div class="stat-card neon-panel">
        <h3>XP</h3>
        {% set xp_required = current_user.level * 100 %}
        {% set xp_percent = ((current_user.xp / xp_required) * 100) | round(2) | default(0) %}

        <div class="xp-bar" style="--xp-width: {{ xp_percent }}%;">
            <div class="xp-fill"></div>
        </div>
        <p>{{ current_user.xp }} / {{ xp_required }} XP</p>
    </div>

    <!-- TOKENS -->
    <div class="stat-card neon-panel">
        <h3>TOKENS</h3>
        <p>{{ current_user.tokens }}</p>
    </div>

</div>

<br><br>

<!-- BOT LIST -->
<h2>Your Bots</h2>

{% if bots %}
    <div class="bot-list hologram-grid">
    {% for item in bots %}
        {% set bot = item.bot %}
        {% set final = item.final_stats %}

        <!-- Wrap bot card in link to edit page -->
        <a href="{{ url_for('edit_bot', bot_id=bot.id) }}" class="bot-link">
            <div class="bot-card holo-card">
                <div class="holo-glow"></div>
                <h3>{{ bot.name }} ({{ bot.algorithm }})</h3>
                <p>
                  INT: {{ final.int }} | PROC: {{ final.proc }} | DEF: {{ final.def }} |
                  CLK: {{ final.clk }} | LOGIC: {{ final.logic }} | ENT: {{ final.ent }} |
                  PWR: {{ final.pwr }}
                </p>
            </div>
        </a>
    {% endfor %}
    </div>
{% else %}
    <p>No bots found â€” create your first bot below.</p>
{% endif %}

<br><br>

<!-- CREATE BOT FORM -->
<h2>Create a New Bot</h2>

<form method="POST">
<div class="mb-3">
    <label for="name">Bot Name:</label><br>
    <input type="text" id="name" name="name" required class="form-control"><br><br>
</div>

<div class="container">
    <label class="form-label fw-bold">Select Algorithm:</label>
    <div class="row row-cols-1 row-cols-md-3 g-3">
        {% for code, label in algorithms.items() %}
        <div class="col">
            <input type="radio"
                   id="{{ code }}"
                   name="algorithm"
                   value="{{ code }}"
                   class="d-none algorithm-radio"
                   required>
            <label for="{{ code }}" class="card algorithm-card text-center p-3"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="{{ algorithm_descriptions[code] }}">
                <h5 class="fw-bold">{{ code }}</h5>
                <p class="text-muted">{{ label }}</p>
            </label>
        </div>
        {% endfor %}
    </div>
</div>

<button type="submit" class="btn btn-outline-primary mt-4">Create Bot</button>
</form>

<br><br>

<!-- ACTION BUTTONS -->
<div class="action-grid">
    <a href="{{ url_for('battle_select') }}" class="action-button">BATTLE</a>
    <a href="{{ url_for('manage_bot') }}" class="action-button">MANAGE BOTS</a>
    <a href="{{ url_for('armory') }}" class="action-button">ARMORY</a>
    <a href="{{ url_for('character') }}" class="action-button">CHARACTER</a>
</div>

<a href="{{ url_for('home') }}" class="icon-btn back-home-btn">
    <i class="fa-solid fa-house"></i>
</a>

{% endblock %}