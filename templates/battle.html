{% extends "base.html" %}

{% block page_title %}Battle Arena | Clash of Code{% endblock %}

{% block content %}


        <!-- Bot 1 dropdown -->
<h1>BATTLE ARENA // CYBER WARFARE</h1>

<div class="container mt-4">
    <div class="alert alert-info">
        <strong>Matchmaking Range:</strong> {{ my_rating - 200 }} - {{ my_rating + 200 }} rating
        <br>
        <small>You'll face opponents with similar skill levels</small>
    </div>

    <form method="POST" class="mt-3">
        
        <!-- Select Your Bot -->
        <div class="mb-3">
            <label class="form-label"><strong>Choose Your Bot:</strong></label>
            <select name="bot1" required>
                <option value="" disabled selected>Select your bot</option>
                {% for bot in my_bots %}
                    <option value="{{ bot.id }}">
                        {{ bot.name }} ({{ bot.algorithm }})
                    </option>
                {% endfor %}
            </select>
            {% if not my_bots %}
                <small class="text-danger">You don't have any bots yet! <a href="{{ url_for('create_bot') }}">Create one</a></small>
            {% endif %}
        </div>

        <!-- Select Opponent -->
        <div class="mb-3">
            <label class="form-label"><strong>Choose Opponent:</strong></label>
            <select name="bot2" required>
                <option value="" disabled selected>Select opponent</option>
                {% if matched_bots %}
                    {% for bot in matched_bots %}
                        {% set total_battles = bot.botwins + bot.botlosses %}
                        {% set win_rate = (bot.botwins / total_battles * 100) | round(1) if total_battles > 0 else 0 %}
                        <option value="{{ bot.id }}">
                            {{ bot.name }} - {{ bot.user.username }} 
                            (Rating: {{ bot.user.rating }})
                            {% if bot.user.rating > my_rating %}
                                ⬆️ Harder
                            {% elif bot.user.rating < my_rating %}
                                ⬇️ Easier
                            {% else %}
                                ⚖️ Equal
                            {% endif %} |
                            Lvl {{ bot.level }} | 
                            {{ bot.algorithm }} | 
                            {{ win_rate }}% WR ({{ bot.botwins }}W - {{ bot.botlosses }}L) | 
                            {{ bot.weapon.type if bot.weapon else "No weapon" }}
                        </option>
                    {% endfor %}
                {% else %}
                    <option disabled>No suitable opponents found in your rating range</option>
                {% endif %}
            </select>
            
            {% if not matched_bots %}
                <div class="alert alert-warning mt-2">
                    <strong>No opponents found!</strong><br>
                    There are no players within your rating range ({{ my_rating - 200 }} - {{ my_rating + 200 }}).
                    <br>
                    <small>This might happen if you're the only active player or if your rating is very high/low.</small>
                </div>
            {% endif %}
        </div>

        
        <a href="{{ url_for('dashboard') }}" class="btn btn-cancel">
            Cancel
        </a>

        <button type="submit" class="btn" {% if not my_bots or not matched_bots %}disabled{% endif %}>
            START BATTLE
        </button>
        
        {% if not my_bots or not matched_bots %}
            <br><small>Button disabled: {{ "Create a bot first" if not my_bots else "No opponents available" }}</small>
        {% endif %}
    </form>

    <br>
    <a href="{{ url_for('dashboard') }}" class="btn">← Back to Dashboard</a>
</div>

{% endblock %}
