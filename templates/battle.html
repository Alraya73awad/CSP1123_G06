{% extends "base.html" %}

{% block page_title %}Battle Arena | Clash of Code{% endblock %}

{% block content %}

<h1>BATTLE ARENA // CYBER WARFARE</h1>

<div id="battle-screen">
    <pre id="battle-log"></pre>
</div>

<div class="container mt-4">
    <h2>Select Bots to Battle</h2>

    <form method="POST" class="mt-3">

        <!-- Bot 1 dropdown -->
        <div class="mb-3">
            <label class="form-label">Choose Fighter 1</label>
            <select name="bot1" class="form-select" required>
                <option value="" disabled selected>Select a bot</option>
                {% for bot in bots %}
                    <option value="{{ bot.id }}">{{ bot.name }} ({{ bot.algorithm }})</option>
                {% endfor %}
            </select>
        </div>

        <!-- Bot 2 dropdown -->
        <div class="mb-3">
            <label class="form-label">Choose Fighter 2</label>
            <select name="bot2" class="form-select" required>
                <option value="" disabled selected>Select a bot</option>
                {% for bot in bots %}
                    <option value="{{ bot.id }}">{{ bot.name }} ({{ bot.algorithm }})</option>
                {% endfor %}
            </select>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, msg in messages %}
                    <div class="alert alert-{{ category }} mt-2">
                        {{ msg }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <button type="submit" id="start-battle" class="login-button">INITIATE BATTLE</button>
        <a href="{{ url_for('bot_list') }}" class="btn btn-secondary">Cancel</a>

    </form>
</div>

<br><br>

<a href="{{ url_for('dashboard') }}">‚Üê Dashboard</a>

{% endblock %}

<script>
// Typewriter effect
function typeLine(line, delay) {
    return new Promise(resolve => {
        let i = 0;
        let log = document.getElementById("battle-log");

        let interval = setInterval(() => {
            log.textContent += line[i];
            i++;

            if (i >= line.length) {
                clearInterval(interval);
                log.textContent += "\n";
                resolve();
            }
        }, delay);
    });
}

document.getElementById("start-battle").onclick = async () => {
    const log = document.getElementById("battle-log");
    log.textContent = ""; // reset

    const lines = [
        "[SYSTEM] Initializing battle protocol...",
        "[SCANNING] Searching for opponent bot...",
        "[MATCH FOUND] Opponent located.",
        "[LOADING] Deploying battle environment...",
        ">>> BATTLE START <<<",
        "[BOT] Executing attack sequence...",
        "[ENEMY] Counterattack detected...",
        "[SYSTEM] Calculating damage...",
        "[RESULT] Victory probability rising...",
        "[FINISH] You won the battle!"
    ];

    for (let line of lines) {
        await typeLine(line, 30);
    }
};
</script>