{% extends "base.html" %}

{% block content %}
<div>

    {% if is_replay %}
        <h2>Battle: {{ history.bot1_name }} vs {{ history.bot2_name }}</h2>
    {% else %}
        <h2>Battle: {{ bot1.name }} vs {{ bot2.name }}</h2>
    {% endif %}

    <h3 class="mt-4">Starting Stats Comparison</h3>

        <table class="stats-comparison table table-bordered text-center mb-4">
            <thead>
                <tr>
                    <th>Stat</th>
                    {% if is_replay %}
                        <th>{{ history.bot1_name }}</th>
                        <th>{{ history.bot2_name }}</th>
                    {% else %}
                        <th>{{ bot1.name }}</th>
                        <th>{{ bot2.name }}</th>
                    {% endif %}
                </tr>
            </thead>

            <tbody>
                
                <!-- ALGORITHM ROW -->
                <tr>
                    <td><strong>ALGORITHM</strong></td>
                    {% if is_replay %}
                        <td>{{ history.bot1_algorithm }}</td>
                        <td>{{ history.bot2_algorithm }}</td>
                    {% else %}
                        <td>{{ bot1.algorithm }}</td>
                        <td>{{ bot2.algorithm }}</td>
                    {% endif %}
                </tr>

                <!-- WEAPON ROW -->
                <tr>
                    <td><strong>WEAPON</strong></td>
                    <td>
                        {% if stats1.weapon_name %}
                            <span>{{ stats1.weapon_name }}</span>
                            <br>
                            <small>+{{ stats1.weapon_atk }} ATK</small>
                        {% elif stats1.weapon_type %}
                            <span>{{ stats1.weapon_type|upper }}</span>
                            <br>
                            <small>+{{ stats1.weapon_atk }} ATK</small>
                        {% else %}
                            <span>No Weapon</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stats2.weapon_name %}
                            <span>{{ stats2.weapon_name }}</span>
                            <br>
                            <small>+{{ stats2.weapon_atk }} ATK</small>
                        {% elif stats2.weapon_type %}
                            <span>{{ stats2.weapon_type|upper }}</span>
                            <br>
                            <small>+{{ stats2.weapon_atk }} ATK</small>
                        {% else %}
                            <span>No Weapon</span>
                        {% endif %}
                    </td>
                </tr>


                <!-- UPGRADES ROW -->
                <tr>
                    <td><strong>UPGRADES</strong></td>
                    <td>
                        {% if stats1.upgrades %}
                            {{ stats1.upgrades | join(", ") }}
                        {% else %}
                            None
                        {% endif %}
                    </td>
                    <td>
                        {% if stats2.upgrades %}
                            {{ stats2.upgrades | join(", ") }}
                        {% else %}
                            None
                        {% endif %}
                    </td>
                </tr>

                <!-- PROC (Total ATK including weapon) ROW -->
                <tr>
                    <td>PROC</td>
                    <td class="{% if stats1.proc > stats2.proc %}text-success fw-bold{% elif stats1.proc < stats2.proc %}text-danger{% else %}text-light{% endif %}">
                        {{ stats1.proc }}
                        {% if stats1.weapon_atk > 0 %}
                            <br><small>(Base + {{ stats1.weapon_atk }} weapon)</small>
                        {% endif %}
                    </td>
                    <td class="{% if stats2.proc > stats1.proc %}text-success fw-bold{% elif stats2.proc < stats1.proc %}text-danger{% else %}text-light{% endif %}">
                        {{ stats2.proc }}
                        {% if stats2.weapon_atk > 0 %}
                            <br><small>(Base + {{ stats2.weapon_atk }} weapon)</small>
                        {% endif %}
                    </td>
                </tr>

                <!-- HP ROW -->
                <tr>
                    <td>INT</td>
                    <td class="{% if stats1.hp > stats2.hp %}text-success fw-bold{% elif stats1.hp < stats2.hp %}text-danger{% else %}text-light{% endif %}">
                        {{ stats1.hp }}
                    </td>
                    <td class="{% if stats2.hp > stats1.hp %}text-success fw-bold{% elif stats2.hp < stats1.hp %}text-danger{% else %}text-light{% endif %}">
                        {{ stats2.hp }}
                    </td>
                </tr>

                <!-- ENERGY ROW -->
                <tr>
                    <td>PWR</td>
                    <td class="{% if stats1.energy > stats2.energy %}text-success fw-bold{% elif stats1.energy < stats2.energy %}text-danger{% else %}text-light{% endif %}">
                        {{ stats1.energy }}
                    </td>
                    <td class="{% if stats2.energy > stats1.energy %}text-success fw-bold{% elif stats2.energy < stats1.energy %}text-danger{% else %}text-light{% endif %}">
                        {{ stats2.energy }}
                    </td>
                </tr>

                <!-- DEFENSE ROW -->
                <tr>
                    <td>DEF</td>
                    <td class="{% if stats1.def > stats2.def %}text-success fw-bold{% elif stats1.def < stats2.def %}text-danger{% else %}text-light{% endif %}">
                        {{ stats1.def }}
                    </td>
                    <td class="{% if stats2.def > stats1.def %}text-success fw-bold{% elif stats2.def < stats1.def %}text-danger{% else %}text-light{% endif %}">
                        {{ stats2.def }}
                    </td>
                </tr>

                <!-- CLK (SPEED) ROW -->
                <tr>
                    <td>CLK</td>
                    <td class="{% if stats1.clk > stats2.clk %}text-success fw-bold{% elif stats1.clk < stats2.clk %}text-danger{% else %}text-light{% endif %}">
                        {{ stats1.clk }}
                    </td>
                    <td class="{% if stats2.clk > stats1.clk %}text-success fw-bold{% elif stats2.clk < stats1.clk %}text-danger{% else %}text-light{% endif %}">
                        {{ stats2.clk }}
                    </td>
                </tr>

                <!-- LUCK ROW -->
                <tr>
                    <td>ENT</td>
                    <td class="{% if stats1.luck > stats2.luck %}text-success fw-bold{% elif stats1.luck < stats2.luck %}text-danger{% else %}text-light{% endif %}">
                        {{ stats1.luck }}
                    </td>
                    <td class="{% if stats2.luck > stats1.luck %}text-success fw-bold{% elif stats2.luck < stats1.luck %}text-danger{% else %}text-light{% endif %}">
                        {{ stats2.luck }}
                    </td>
                </tr>
            </tbody>
        </table>

    <div>
        <div class="combat-log-output" id="combat-log-output" style="
            max-height: 70vh;
            overflow-y: auto;
            background: black;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        "></div>

        <div class="mt-3 d-flex gap-2">
            <button id="skip-log" class="btn btn-outline-secondary" type="button">Skip to End</button>
            <small id="log-progress" class="text-muted align-self-center"></small>
        </div>
    </div>

    <script type="application/json" id="combat-log-data">
        {{ log | tojson }}
    </script>

    <script>
    (function() {
        const output = document.getElementById("combat-log-output");
        const skipBtn = document.getElementById("skip-log");
        const progress = document.getElementById("log-progress");
        const dataEl = document.getElementById("combat-log-data");
        const lines = JSON.parse(dataEl.textContent || "[]");

        const intervalMs = 2000;
        let index = 0;
        let timer = null;

        function renderLine(type, text) {
            const span = document.createElement("span");
            span.className = "log-text " + type;
            span.textContent = text;
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        function updateProgress() {
            progress.textContent = `Showing ${index} / ${lines.length}`;
        }

        function step() {
            if (index >= lines.length) {
                clearInterval(timer);
                timer = null;
                skipBtn.disabled = true;
                updateProgress();
                return;
            }
            const entry = lines[index];
            renderLine(entry[0], entry[1]);
            index += 1;
            updateProgress();
        }

        function start() {
            updateProgress();
            timer = setInterval(step, intervalMs);
        }

        skipBtn.addEventListener("click", function() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            while (index < lines.length) {
                const entry = lines[index];
                renderLine(entry[0], entry[1]);
                index += 1;
            }
            updateProgress();
            skipBtn.disabled = true;
        });

        start();
    })();
    </script>

    {% if winner %}
    <div class="alert alert-success mt-3">
        Winner: {{ winner }}
    </div>
    {% endif %}

    {% if is_replay %}
        <a href="{{ url_for('history') }}" class="btn btn-secondary mt-3">← Back to History</a>
    {% else %}
        <a href="{{ url_for('dashboard', bot_id=bot1.id) }}" class="btn btn-secondary mt-3">← Back to Dashboard</a>
    {% endif %}

</div>
{% endblock %}
