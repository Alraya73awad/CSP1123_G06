{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <h2>Edit Bot — {{ bot.name }}</h2>
    <p><strong>XP Available:</strong> {{ xp_balance }}</p>
    {% if is_admin %}
      <div class="alert alert-info">Admin mode: free upgrades enabled.</div>
    {% else %}
      <div class="alert alert-warning">Upgrading stats will deduct XP.</div>
    {% endif %}

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} mt-2">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Stat Upgrades -->
    <h5>Upgrade Stats</h5>
    {% for stat, limits in stat_limits.items() %}
    <div class="mb-3">
        <label class="form-label">{{ stat.upper() }} ({{ limits[0] }}–{{ limits[1] }})</label>

        <!-- Single-point +/- buttons -->
        <form method="POST" class="d-inline">
            <button type="submit" name="adjust" value="{{ stat }}:-1" class="btn btn-outline-secondary">-</button>
            <span class="px-3">{{ bot|getattr(stat) }}</span>
            <button type="submit" name="adjust" value="{{ stat }}:+1" class="btn btn-outline-secondary">+</button>
        </form>

        <!-- Multi-level upgrade -->
        <form method="POST" class="d-inline ms-3">
            <input type="hidden" name="stat" value="{{ stat }}">
            <input type="number" name="levels"
                   min="1"
                   max="{{ limits[1] - bot|getattr(stat) }}"
                   value="1"
                   class="form-control d-inline"
                   style="width:80px;">
            <button type="submit" class="btn btn-outline-primary">Upgrade Levels</button>
        </form>
    </div>
    {% endfor %}

    <!-- Equip Weapon -->
    <div class="mb-3">
        <label>Equip Weapon</label>
        <select name="weapon_id" class="form-select" form="equip-form">
            {% for weapon in owned_weapons %}
              <option value="{{ weapon.id }}" {% if bot.weapon_id == weapon.id %}selected{% endif %}>
                {{ weapon.name }} (Cost: {{ weapon.price }})
              </option>
            {% endfor %}
        </select>
    </div>

    <!-- Equip Ability -->
    <div class="mb-3">
        <label>Equip Ability</label>
        <select name="ability_id" class="form-select" form="equip-form">
            {% for ability in owned_abilities %}
              <option value="{{ ability.id }}" {% if bot.ability_id == ability.id %}selected{% endif %}>
                {{ ability.name }}
              </option>
            {% endfor %}
        </select>
    </div>

    <!-- Save Equipment -->
    <form method="POST" id="equip-form">
        <button type="submit" class="btn btn-primary">Save Equipment</button>
        <a href="{{ url_for('bot_list') }}" class="btn btn-secondary">Cancel</a>
    </form>

    <!-- Sell Weapons Section -->
    <div class="mt-4">
        <h5>Sell Weapons</h5>
        {% for weapon in owned_weapons %}
        <form method="POST" action="{{ url_for('sell_weapon', weapon_id=weapon.id, bot_id=bot.id) }}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>{{ weapon.name }} — Refund: {{ (weapon.price * 0.6)|int }} XP</span>
                <button type="submit" class="btn btn-danger btn-sm">Sell</button>
            </div>
        </form>
        {% endfor %}
    </div>

</div>
{% endblock %}