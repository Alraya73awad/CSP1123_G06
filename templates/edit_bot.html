{% extends "base.html" %}

{% block head %}
<style>
.algorithm-card {
    border: 2px solid #ccc;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.2s;
}

.algorithm-card:hover {
    border-color: #0d6efd !important;
    background-color: #f0f8ff !important;
}

.algorithm-radio:checked + .algorithm-card {
    border-color: #0d6efd;
    background-color: #e7f1ff;
    box-shadow: 0 0 8px rgba(13, 110, 253, 0.4);
}

</style>
{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2>Edit Bot — {{ bot.name }}</h2>

    <!-- Flash messages -->
    {% if request.args.get('flash') %}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} mt-2">{{ message }}</div>
        {% endfor %}
      {% endif %}
     {% endwith %}
    {% endif %}


    <form method="POST">

        <div class="mb-3">
            <label for="name">Bot Name:</label><br>
            <input type="text" id="name" name="name" value="{{ bot.name }}" class="form-control"><br><br>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Select Algorithm</label>

            <div class="row row-cols-1 row-cols-md-3 g-3">

                {% for code, label in algorithms.items() %}
                <div class="col">

                    <!-- RADIO INPUT -->
                    <input type="radio"
                        class="btn-check algorithm-radio"
                        name="algorithm"
                        id="alg-{{ code }}"
                        value="{{ code }}"
                        autocomplete="off"
                        {% if bot.algorithm == code %} checked {% endif %}>

                    <!-- CARD LABEL -->
                    <label class="btn card p-3 text-center algorithm-card" for="alg-{{ code }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ algorithm_descriptions[code] }}">
                        <h6>{{ code }}</h6>
                        <p class="small">{{ label }}</p>
                    </label>

                </div>
                {% endfor %}

            </div>
        </div>


        <div class="mb-4">
            <h5>Current Stats</h5>
            <ul class="list-group">
                <li class="list-group-item" data-bs-toggle="tooltip" title="Integrity Core (INT): Your bot's maximum health.">INT: {{ bot.hp }}</li>
                <li class="list-group-item" data-bs-toggle="tooltip" title="Processing Output (PROC): Physical damage output. Increases the amount of damage your bot deals.">PROC: {{ bot.atk }}</li>
                <li class="list-group-item" data-bs-toggle="tooltip" title="Defense Matrix (DEF): Reduces incoming damage.">DEF: {{ bot.defense }}</li>
                <li class="list-group-item" data-bs-toggle="tooltip" title="Clock Rate (CLK): Turn order + evasion. Faster bots act earlier and dodge more often.">CLK: {{ bot.speed }}</li>
                <li class="list-group-item" data-bs-toggle="tooltip" title="Adaptive Logic (LOGIC): AI decision-making efficiency. Improves accuracy and special move success.">LOGIC: {{ bot.logic }}</li>
                <li class="list-group-item" data-bs-toggle="tooltip" title="Entropy Coefficient (ENT): Random bonus events, crit chance, and rare effects. Unpredictable but powerful.">ENT: {{ bot.luck }}</li>
                <li class="list-group-item" data-bs-toggle="tooltip" title="Power Core Capacity (PWR): Resource used for skills or abilities. Higher energy allows more actions.">PWR: {{ bot.energy }}</li>
            </ul>
        </div>

        <h5>Adjust Stats</h5>
        <div class="stat-points-panel">
            <p>
                <strong>Stat Points Available:</strong>
                <span id="sp-available">{{ bot.stat_points }}</span>
            </p>
            <p>
                <strong>Stat Points Required:</strong>
                <span id="sp-required">0</span>
            </p>    
        </div>

        <!-- ATK -->
        <div style="display:flex; flex-direction: column;" class="mb-3 stat-row">
            <label data-bs-toggle="tooltip" title="Processing Output (PROC): Physical damage output. Increases the amount of damage your bot deals.">PROC</label>
            <a href="{{ url_for('gear', bot_id=bot.id) }}">Go to Gear</a>
        </div>

        <!-- HP -->
        <div class="mb-3 stat-row" >
            <label class="form-label" data-bs-toggle="tooltip" title="Integrity Core: Your bot's maximum health.">INT ({{ stat_limits.hp[0] }}–{{ stat_limits.hp[1] }})</label>
            <input type="range" name="hp" class="form-range stat-slider"
                   min="{{ stat_limits.hp[0] }}" max="{{ stat_limits.hp[1] }}" value="{{ bot.hp }}">
            <input type="number" class="form-control mt-2 stat-number"
                   name="hp_number" value="{{ bot.hp }}"
                   min="{{ stat_limits.hp[0] }}" max="{{ stat_limits.hp[1] }}">
        </div>

        <!-- DEF -->
        <div class="mb-3 stat-row">
            <label class="form-label" data-bs-toggle="tooltip" title="Defense Matrix (DEF): Reduces incoming damage.">DEF ({{ stat_limits.defense[0] }}–{{ stat_limits.defense[1] }})</label>
            <input type="range" name="defense" class="form-range stat-slider"
                   min="{{ stat_limits.defense[0] }}" max="{{ stat_limits.defense[1] }}" value="{{ bot.defense }}">
            <input type="number" class="form-control mt-2 stat-number"
                   name="defense_number" value="{{ bot.defense }}"
                   min="{{ stat_limits.defense[0] }}" max="{{ stat_limits.defense[1] }}">
        </div>

        <!-- SPEED -->
        <div class="mb-3 stat-row">
            <label class="form-label" data-bs-toggle="tooltip" title="Clock Rate (CLK): Turn order + evasion. Faster bots act earlier and dodge more often.">CLK ({{ stat_limits.speed[0] }}–{{ stat_limits.speed[1] }})</label>
            <input type="range" name="speed" class="form-range stat-slider"
                   min="{{ stat_limits.speed[0] }}" max="{{ stat_limits.speed[1] }}" value="{{ bot.speed }}">
            <input type="number" class="form-control mt-2 stat-number"
                   name="speed_number" value="{{ bot.speed }}"
                   min="{{ stat_limits.speed[0] }}" max="{{ stat_limits.speed[1] }}">
        </div>

        <!-- LOGIC -->
        <div class="mb-3 stat-row">
            <label class="form-label" data-bs-toggle="tooltip" title="Adaptive Logic (LOGIC): AI decision-making efficiency. Improves accuracy and special move success.">LOGIC ({{ stat_limits.logic[0] }}–{{ stat_limits.logic[1] }})</label>
            <input type="range" name="logic" class="form-range stat-slider"
                   min="{{ stat_limits.logic[0] }}" max="{{ stat_limits.logic[1] }}" value="{{ bot.logic }}">
            <input type="number" class="form-control mt-2 stat-number"
                   name="logic_number" value="{{ bot.logic }}"
                   min="{{ stat_limits.logic[0] }}" max="{{ stat_limits.logic[1] }}">
        </div>

        <!-- LUCK -->
        <div class="mb-3 stat-row">
            <label class="form-label" data-bs-toggle="tooltip" title="Entropy Coefficient (ENT): Random bonus events, crit chance, and rare effects. Unpredictable but powerful.">ENT ({{ stat_limits.luck[0] }}–{{ stat_limits.luck[1] }})</label>
            <input type="range" name="luck" class="form-range stat-slider"
                   min="{{ stat_limits.luck[0] }}" max="{{ stat_limits.luck[1] }}" value="{{ bot.luck }}">
            <input type="number" class="form-control mt-2 stat-number"
                   name="luck_number" value="{{ bot.luck }}"
                   min="{{ stat_limits.luck[0] }}" max="{{ stat_limits.luck[1] }}">
        </div>

        <!-- ENERGY -->
        <div class="mb-3 stat-row">
            <label class="form-label" data-bs-toggle="tooltip" title="Power Core Capacity (PWR): Resource used for skills or abilities. Higher energy allows more actions.">PWR ({{ stat_limits.energy[0] }}–{{ stat_limits.energy[1] }})</label>
            <input type="range" name="energy" class="form-range stat-slider"
                   min="{{ stat_limits.energy[0] }}" max="{{ stat_limits.energy[1] }}" value="{{ bot.energy }}">
            <input type="number" class="form-control mt-2 stat-number"
                   name="energy_number" value="{{ bot.energy }}"
                   min="{{ stat_limits.energy[0] }}" max="{{ stat_limits.energy[1] }}">
        </div>

        <button type="submit" name="preview" value="1" class="btn btn-primary">Preview Upgrades</button>
        <a href="{{ url_for('manage_bot') }}" class="btn btn-secondary">Cancel</a>
        
    </form>
</div>
{% endblock %}

{% block scripts %}
<script type="application/json" id="current-stats">
{{ {
  'hp': bot.hp,
  'atk': bot.atk,
  'defense': bot.defense,
  'speed': bot.speed,
  'logic': bot.logic,
  'luck': bot.luck,
  'energy': bot.energy
} | tojson }}
</script>

<script>
const CURRENT_STATS = JSON.parse(document.getElementById("current-stats").textContent);

function recalcRequired() {
  let required = 0;

  document.querySelectorAll(".stat-row").forEach(row => {
    const slider = row.querySelector(".stat-slider");
    const number = row.querySelector(".stat-number");
    if (!slider || !number) return;

    const stat = slider.name; // hp, defense, speed, etc
    const desired = parseInt(number.value || slider.value, 10);
    const current = CURRENT_STATS[stat];

    if (!Number.isNaN(desired) && desired > current) {
      required += (desired - current);
    }
  });

  const output = document.getElementById("sp-required");
  if (output) output.textContent = required;
}

document.querySelectorAll(".stat-row").forEach(row => {
  const slider = row.querySelector(".stat-slider");
  const number = row.querySelector(".stat-number");
  if (!slider || !number) return;

  slider.addEventListener("input", () => {
    number.value = slider.value;
    recalcRequired();
  });

  number.addEventListener("input", () => {
    slider.value = number.value;
    recalcRequired();
  });

  number.addEventListener("blur", recalcRequired);
});

// initial calculation
recalcRequired();
</script>
{% endblock %}
