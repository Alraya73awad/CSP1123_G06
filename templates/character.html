{% extends "base.html" %}

{% block page_title %}Character | Clash of Code{% endblock %}

{% block content %}
<div class="terminal-container">

    <!-- header -->
    <div class="header">
        <span>CLASH OF CODE TERMINAL â€” CHARACTER MODULE</span>
        <span id="datetime-display">--/--/---- --:--:--</span>
    </div>

    <h1>Your Characters</h1>
    <p>Select a character to equip upgrades.</p>

    <!-- character dropdown -->
    <div class="character-select">
        <label for="selected-character">Select Character:</label>
        <select id="selected-character" name="character_id" class="bot-dropdown" {% if bots|length == 0 %}disabled{% endif %}>
            {% for bot in bots %}
                <option value="{{ bot.id }}">{{ bot.name }}</option>
            {% endfor %}
        </select>
        {% if bots|length == 0 %}
            <p style="margin-top:10px; color:#ffae00;">No bots found. Create a bot first.</p>
        {% endif %}
    </div>

    <h2>Upgrades</h2>
    <p>! This is a one-time use upgrade !</p>

    <!-- upgrades grid -->
    <div class="store-grid">
        {% set tokens = user.tokens if user and user.tokens is not none else 0 %}

        {% for upgrade in CHARACTER_ITEMS %}
        <div class="store-item" {% if bots|length == 0 %}style="opacity:0.5; pointer-events:none;"{% endif %}>
            <h3>{{ upgrade["name"] }}</h3>
            <p>{{ upgrade["desc"] }}</p>
            <p>Cost: {{ upgrade["cost"] }} Bits</p>

            <form method="POST" action="{{ url_for('buy_character') }}">
                <input type="hidden" name="purchase_id" value="{{ upgrade["id"] }}">
                <input type="hidden" name="bot_id" value="{{ bots[0].id if bots else '' }}" class="selected-bot-input">

                <button type="submit" class="buy-btn"
                        {% if tokens < upgrade["cost"] or bots|length == 0 %}disabled{% endif %}>
                    {% if tokens < upgrade["cost"] %}Not enough bits{% else %}Purchase{% endif %}
                </button>
            </form>
        </div>
        {% endfor %}
    </div>

    <div style="text-align:center; margin-top: 35px;">
        <a href="{{ url_for('dashboard') }}" class="back-btn">Return</a>
    </div>

   <!-- Status Area -->
    <div class="status-area">
        <p>LEVEL: {{ user.level }}</p>
        <p>Bits Available: {{ tokens }}</p>
        <p>XP Progress:</p>

        <div class="xp-bar" style="width: 100%; background: rgba(0,0,0,0.2); height: 25px; border-radius: 6px;">
            <div style="height: 100%;
                width: {{ ((user.xp / xp_to_next) * 100) | round(1) if xp_to_next > 0 else 0 }}%;
                background: #00ffaa;
                border-radius: 6px;">
            </div>
        </div>
        <p>{{ user.xp }} / {{ xp_to_next }} XP</p>
    </div>

<!-- Styles -->
<style>
.terminal-container {
    width: 95%;
    max-width: 1000px;
    padding: 40px;
    border: 2px solid #00ffaa;
    box-shadow: 0 0 10px #00ffaa;
    border-radius: 12px;
    background-color: rgba(0,0,10,0.7);
    position: relative;
    box-sizing: border-box;
    font-family: 'VT323', monospace;
    color: #00ffaa;
}

.header {
    display: flex;
    justify-content: space-between;
    font-size: 1.3rem;
    border-bottom: 1px solid rgba(0,255,170,0.2);
    margin-bottom: 30px;
    padding-bottom: 8px;
}

.character-select {
    margin-bottom: 25px;
}

.store-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
}

.store-item {
    border: 2px solid #00ffaa;
    padding: 20px;
    background: rgba(0,255,170,0.08);
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,255,170,0.2);
    transition: 0.2s;
}

.store-item:hover {
    transform: scale(1.03);
    box-shadow: 0 0 25px rgba(0,255,170,0.5);
}

.store-item h3 { font-size: 1.7rem; margin-bottom: 10px; }
.store-item p  { margin: 5px 0; font-size: 1.2rem; }

.buy-btn {
    margin-top: 10px;
    display: block;
    width: 100%;
    text-align: center;
    border: 2px solid #00ffaa;
    padding: 10px;
    font-size: 1.3rem;
    text-decoration: none;
    color: #00ffaa;
    background: rgba(0,255,170,0.07);
    transition: 0.2s;
    border-radius: 6px;
}

.buy-btn:hover:not([disabled]) {
    background: rgba(0,255,170,0.3);
    box-shadow: 0 0 15px #00ffaa;
}

.bot-dropdown {
    width: 50%;
    padding: 8px;
    border: 2px solid #00ffaa;
    border-radius: 6px;
    background: rgba(0,0,0,0.2);
    color: #00ffaa;
    text-align: center;
    margin-top: 5px;
    margin-bottom: 10px;
    transition: 0.2s;
}

.bot-dropdown:focus {
    outline: none;
    box-shadow: 0 0 10px #00ffaa;
    border-color: #00ffaa;
}

.back-btn {
    margin-top: 30px;
    display: inline-block;
    padding: 12px 35px;
    border: 2px solid #00aaff;
    color: #00aaff;
    background: rgba(0,170,255,0.08);
    text-decoration: none;
    font-size: 1.5rem;
    text-shadow: 0 0 5px #00aaff;
    border-radius: 6px;
    transition: 0.2s;
}

.back-btn:hover {
    background: rgba(0,170,255,0.25);
    box-shadow: 0 0 15px #00aaff;
}

.status-area {
    margin-top: 35px;
    pointer-events: none;
}

</style>

<!-- Scripts -->
<script>
function updateDateTime() {
    const now = new Date();
    const date = now.toLocaleDateString('en-US');
    const time = now.toLocaleTimeString('en-US', { hour12: false });
    document.getElementById("datetime-display").textContent = `${date} ${time}`;
}
setInterval(updateDateTime, 1000);
updateDateTime();

// Update hidden bot_id inputs when dropdown changes
const botDropdown = document.getElementById("selected-character");
if (botDropdown) {
    botDropdown.addEventListener("change", function() {
        const selectedBotId = this.value;
        document.querySelectorAll(".selected-bot-input").forEach(input => {
            input.value = selectedBotId;
        });
    });
}
</script>

{% endblock %}
